<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NmapFusion - Security Assessment Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e14;
            color: #e6e9f0;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1e2a3a 0%, #0f1a2b 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #00bcd4;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #00bcd4;
        }
        
        .timestamp {
            color: #8899aa;
            font-size: 0.9em;
        }
        
        .report-id {
            color: #00bcd4;
            font-size: 0.9em;
            font-family: monospace;
            margin-top: 5px;
        }
        
        /* Command Panel */
        .command-panel {
            background: #0f1a2b;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #2a3a4a;
        }
        
        .command-panel h3 {
            color: #00bcd4;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .command-box {
            background: #1a2634;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            color: #00bcd4;
            border-left: 4px solid #00bcd4;
            margin-bottom: 10px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a2634;
            padding: 20px;
            border-radius: 10px;
            border-bottom: 3px solid #00bcd4;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #00bcd4;
        }
        
        .stat-card .label {
            color: #8899aa;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Tables */
        .table-container {
            background: #1a2634;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .table-container h2 {
            color: #00bcd4;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
            border-bottom: 2px solid #00bcd4;
            padding-bottom: 10px;
        }
        
        .table-container h2 span {
            background: #00bcd4;
            color: #0a0e14;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        th {
            background: #0f1a2b;
            color: #00bcd4;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #00bcd4;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #2a3a4a;
        }
        
        tr:hover {
            background: #1f2e3b;
        }
        
        /* Risk Badges */
        .risk-critical, .risk-high, .risk-medium, .risk-low {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85em;
            text-align: center;
            display: inline-block;
            text-transform: uppercase;
        }
        
        .risk-critical {
            background: #ff4444;
            color: white;
        }
        
        .risk-high {
            background: #ff8800;
            color: white;
        }
        
        .risk-medium {
            background: #ffbb33;
            color: black;
        }
        
        .risk-low {
            background: #00C851;
            color: white;
        }
        
        /* Collapsible Cards */
        .host-card {
            background: #0f1a2b;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #2a3a4a;
        }
        
        .host-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, #1a2a3a 0%, #0f1a2b 100%);
            border-radius: 8px 8px 0 0;
        }
        
        .host-header:hover {
            background: #1a2a3a;
        }
        
        .host-content {
            padding: 20px;
            border-top: 1px solid #2a3a4a;
            display: none;
        }
        
        .host-content.active {
            display: block;
        }
        
        /* NSE Findings */
        .nse-finding {
            background: #1a2634;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #ffbb33;
        }
        
        .cve-item {
            background: #2a1a1a;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 5px;
            border-left: 3px solid #ff4444;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
        
        /* Subnet Badge */
        .subnet-badge {
            background: #2a3a4a;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #00bcd4;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #8899aa;
            border-top: 1px solid #2a3a4a;
            margin-top: 40px;
        }
        
        /* Port Frequency Colors */
        .port-high {
            color: #ff4444;
            font-weight: bold;
        }
        
        .port-medium {
            color: #ff8800;
            font-weight: bold;
        }
        
        .port-low {
            color: #00C851;
            font-weight: bold;
        }
        
        /* Executive Summary */
        .executive-summary {
            background: #0f1a2b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #00bcd4;
        }
        
        .executive-summary h2 {
            color: #00bcd4;
            margin-bottom: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #2a3a4a;
        }
        
        .summary-label {
            color: #8899aa;
        }
        
        .summary-value {
            color: #e6e9f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîç NmapFusion - Security Assessment Report</h1>
            <div class="timestamp">Generated: {{ timestamp }}</div>
            <div class="report-id">Report ID: NMAP-{{ timestamp|replace(' ', '-')|replace(':', '') }}</div>
        </div>
        
        <!-- Nmap Command Panel -->
        <div class="command-panel">
            <h3>üéØ Scan Configuration</h3>
            {% for cmd in nmap_commands %}
            <div class="command-box">{{ cmd }}</div>
            {% endfor %}
        </div>
        
        <!-- Fusion Summary -->
        <div class="command-panel" style="border-color: #9c27b0;">
            <h3>üîÑ Data Fusion Statistics</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div>üìÅ Files Processed: <strong>{{ fusion_summary.files_processed }}</strong></div>
                <div>üåê Unique IPs: <strong>{{ fusion_summary.unique_ips }}</strong></div>
                <div>üîå Ports After Fusion: <strong>{{ fusion_summary.ports_after_fusion }}</strong></div>
                <div>üîÑ Duplicates Removed: <strong>{{ fusion_summary.duplicate_ports_removed }}</strong></div>
                <div>üìú NSE Scripts: <strong>{{ fusion_summary.nse_merged }}</strong></div>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="value">{{ stats.total_hosts }}</div>
                <div class="label">Total Hosts</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ stats.total_ports }}</div>
                <div class="label">Open Ports</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ stats.total_cves }}</div>
                <div class="label">CVEs Found</div>
            </div>
            <div class="stat-card">
                <div class="value">{{ stats.total_weak_ciphers }}</div>
                <div class="label">Weak Ciphers</div>
            </div>
        </div>
        
        <!-- TABLE 1: HOST SUMMARY OVERVIEW -->
        {% if 'table1' in selected_tables %}
        <div class="table-container">
            <h2><span>TABLE 1</span> HOST SUMMARY OVERVIEW</h2>
            <table>
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Hostname</th>
                        <th>Total Ports</th>
                        <th>TCP</th>
                        <th>UDP</th>
                        <th>Services</th>
                        <th>Operating System</th>
                        <th>Risk Level</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table1 %}
                    <tr>
                        <td><strong>{{ row.ip }}</strong></td>
                        <td>{{ row.hostname if row.hostname else '‚Äî' }}</td>
                        <td>{{ row.total_ports }}</td>
                        <td>{{ row.tcp_ports }}</td>
                        <td>{{ row.udp_ports }}</td>
                        <td>{{ row.total_services }}</td>
                        <td>{{ row.os[:30] if row.os != 'unknown' else '‚Äî' }}</td>
                        <td><span class="risk-{{ row.risk_level }}">{{ row.risk_level.upper() }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        <!-- TABLE 2: HOST DETAILED ANALYSIS -->
        {% if 'table2' in selected_tables %}
        <div class="table-container">
            <h2><span>TABLE 2</span> HOST DETAILED ANALYSIS</h2>
            {% for ip, data in table2.items() %}
            <div class="host-card">
                <div class="host-header" onclick="this.nextElementSibling.classList.toggle('active')">
                    <div>
                        <strong style="font-size: 1.1em;">{{ ip }}</strong>
                        {% if data.hostname %}
                        <span style="color: #8899aa; margin-left: 10px;">({{ data.hostname }})</span>
                        {% endif %}
                        <span style="margin-left: 15px;">OS: {{ data.os[:20] }}</span>
                        <span style="margin-left: 15px;" class="risk-{{ data.risk_level }}">
                            {{ data.risk_level.upper() }}
                        </span>
                    </div>
                    <div style="color: #00bcd4;">‚ñº</div>
                </div>
                <div class="host-content">
                    <h4 style="color: #00bcd4; margin-bottom: 15px;">Open Ports ({{ data.ports|length }})</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Port</th>
                                <th>Protocol</th>
                                <th>Service</th>
                                <th>Version</th>
                                <th>Risk</th>
                                <th>NSE Findings</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for port in data.ports %}
                            <tr>
                                <td><strong>{{ port.port }}</strong></td>
                                <td>{{ port.protocol }}</td>
                                <td>{{ port.service }}</td>
                                <td>{{ port.version[:40] if port.version != 'unknown' else '‚Äî' }}</td>
                                <td><span class="risk-{{ port.risk }}">{{ port.risk.upper() }}</span></td>
                                <td>
                                    {% if port.nse_summary %}
                                        {% for summary in port.nse_summary[:2] %}
                                            {{ summary[:60] }}{% if not loop.last %}; {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        ‚Äî
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    {% if data.cves %}
                    <h4 style="color: #ff4444; margin: 20px 0 10px 0;">Vulnerabilities Detected</h4>
                    {% for cve in data.cves[:5] %}
                    <div class="cve-item">{{ cve.id }} {% if cve.port %}(Port {{ cve.port }}){% endif %}</div>
                    {% endfor %}
                    {% endif %}
                    
                    {% if data.weak_ciphers %}
                    <h4 style="color: #ffbb33; margin: 20px 0 10px 0;">Weak Cryptographic Configurations</h4>
                    {% for cipher in data.weak_ciphers[:3] %}
                    <div class="nse-finding">{{ cipher.cipher }} {% if cipher.port %}(Port {{ cipher.port }}){% endif %}</div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- TABLE 3: PORT FREQUENCY DISTRIBUTION -->
        {% if 'table3' in selected_tables %}
        <div class="table-container">
            <h2><span>TABLE 3</span> PORT FREQUENCY DISTRIBUTION</h2>
            <table>
                <thead>
                    <tr>
                        <th>Port</th>
                        <th>Protocol</th>
                        <th>Host Count</th>
                        <th>Service</th>
                        <th>Sample Hosts</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in table3[:20] %}
                    <tr>
                        <td>
                            {% if row.count >= 10 %}
                                <span class="port-high">{{ row.port }}</span>
                            {% elif row.count >= 5 %}
                                <span class="port-medium">{{ row.port }}</span>
                            {% else %}
                                <span class="port-low">{{ row.port }}</span>
                            {% endif %}
                        </td>
                        <td>{{ row.protocol }}</td>
                        <td><strong>{{ row.count }}</strong></td>
                        <td>{{ row.service }}</td>
                        <td>{{ row.ip_list[:5]|join(', ') }}{% if row.ip_list|length > 5 %} +{{ row.ip_list|length - 5 }} more{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p style="margin-top: 15px; color: #8899aa;">Total unique ports: {{ table3|length }} | Most frequent: {{ table3[0].port }}/{{ table3[0].protocol }} ({{ table3[0].count }} hosts)</p>
        </div>
        {% endif %}
        
        <!-- TABLE 4: SERVICE EXPOSURE MATRIX -->
        {% if 'table4' in selected_tables %}
        <div class="table-container">
            <h2><span>TABLE 4</span> SERVICE EXPOSURE MATRIX</h2>
            {% for port_key, data in table4.items() %}
            <div style="margin-bottom: 30px;">
                <h3 style="color: #00bcd4; border-bottom: 2px solid #00bcd4; padding-bottom: 10px;">
                    Port {{ data.port }}/{{ data.protocol }} ‚Äî Exposed on {{ data.host_count }} host{% if data.host_count != 1 %}s{% endif %}
                    <span style="font-size: 0.8em; color: #8899aa; margin-left: 15px;">Service: {{ data.service }}</span>
                </h3>
                <table>
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Hostname</th>
                            <th>Operating System</th>
                            <th>Service Version</th>
                            <th>Risk Level</th>
                            <th>Business Function</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for host in data.hosts[:15] %}
                        <tr>
                            <td><strong>{{ host.ip }}</strong></td>
                            <td>{{ host.hostname if host.hostname else '‚Äî' }}</td>
                            <td>{{ host.os[:20] }}</td>
                            <td>{{ host.version[:40] if host.version != 'unknown' else '‚Äî' }}</td>
                            <td><span class="risk-{{ host.risk }}">{{ host.risk.upper() }}</span></td>
                            <td>{{ host.business_function|replace('_', ' ')|title }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if data.hosts|length > 15 %}
                <p style="margin-top: 10px; color: #8899aa;">... and {{ data.hosts|length - 15 }} additional hosts</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- EXECUTIVE SUMMARY -->
        <div class="executive-summary">
            <h2>üìä EXECUTIVE SUMMARY</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">Total Hosts Analyzed:</span>
                    <span class="summary-value">{{ stats.total_hosts }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Total Open Ports:</span>
                    <span class="summary-value">{{ stats.total_ports }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">CVEs Identified:</span>
                    <span class="summary-value">{{ stats.total_cves }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Weak Ciphers:</span>
                    <span class="summary-value">{{ stats.total_weak_ciphers }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Critical Risk Hosts:</span>
                    <span class="summary-value" style="color: #ff4444;">{{ stats.risk_counts.critical }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">High Risk Hosts:</span>
                    <span class="summary-value" style="color: #ff8800;">{{ stats.risk_counts.high }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Medium Risk Hosts:</span>
                    <span class="summary-value" style="color: #ffbb33;">{{ stats.risk_counts.medium }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Low Risk Hosts:</span>
                    <span class="summary-value" style="color: #00C851;">{{ stats.risk_counts.low }}</span>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Generated by NmapFusion ‚Äî Enterprise Network Assessment Tool</p>
            <p style="margin-top: 10px; font-size: 0.8em;">This report is confidential and intended for authorized security assessment purposes only.</p>
        </div>
    </div>
    
    <script>
        // Toggle host details
        document.querySelectorAll('.host-header').forEach(header => {
            header.addEventListener('click', function() {
                this.nextElementSibling.classList.toggle('active');
            });
        });
        
        // Auto-expand first host
        if (document.querySelector('.host-content')) {
            document.querySelector('.host-content').classList.add('active');
        }
    </script>
</body>
</html>
